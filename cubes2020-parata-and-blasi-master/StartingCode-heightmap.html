<html>

<head>
	<title>Starting Code for 1st Project 2017</title>
	<style>
		body {
			font-family: Monospace;
			background-color: #f0f0f0;
			margin: 0px;
			overflow: hidden;
		}

		canvas {
			width: 100%;
			height: 100%;
		}
	</style>
	<script src="lib/three.min.js"></script>
	<script src="lib/stats.min.js"></script>
	<script src="lib/Coordinates.js"></script>
	<script src="lib/OrbitControls.js"></script>
</head>

<body>

	<script>
		//GENERAL VARIABLE 
		var scene, camera, renderer, controls, stats;
		var matrix = [];

		//CUBE VARIABLE
		var geometry;
		var mapMaterial;
		var playerMaterial;
		var cubeMap;
		var cubePlayer;
		var edge;
		var line;
		var cubePlayerPosition;

		//CUBE LIGHT
		var spotLight;
	




		//return array with height data from img, taken from: http://danni-three.blogspot.it/2013/09/threejs-heightmaps.html
		function getHeightData(img, scale) {

			if (scale == undefined) scale = 1;

			var canvas = document.createElement('canvas');
			canvas.width = img.width;
			canvas.height = img.height;
			var context = canvas.getContext('2d');

			var size = img.width * img.height;
			console.log(size);
			var data = new Float32Array(size);

			context.drawImage(img, 0, 0);

			for (var i = 0; i < size; i++) {
				data[i] = 0
			}

			var imgd = context.getImageData(0, 0, img.width, img.height);
			var pix = imgd.data;

			var j = 0;
			for (var i = 0; i < pix.length; i += 4) {
				var all = pix[i] + pix[i + 1] + pix[i + 2]; // all is in range 0 - 255*3
				data[j++] = scale * all / 3;
			}

			return data;
		}

		function Start() {
			scene = new THREE.Scene();

			InizializeRenderer(); //Inizializza il renderer
			InizializeCamera(); //Inizializza la camera
			InitializeCube(); //Inizializza i cubi
			CreateStats(); //Fa apparire gli stats della scena
			CreateLight(); //Crea la luce della scena

			CreateMatrix(); //Crea la matrice assegnando false alle caselle vuote 			
			CreateMap(); //Crea la mappa in base alla matrice creata sopra




			//Attivazione ascolto comandi per gli spostamenti del cubo
			document.addEventListener("keydown", onDocumentKeyDown, false);

			//Responsive window
			window.addEventListener("resize", onWindowResize, false);

			function onWindowResize(){
				camera.aspect = window.innerWidth/window.innerHeight;
				camera.updateProjectionMatrix();
				renderer.setSize(window.innerWidth, window.innerHeight);
			}
			


			cubePlayer.position.set(0, 1, 0);




			DrawPlayer();
			scene.add(cubePlayer);


			//Coordinates.drawAllAxes();				//Per mostrare le coordinate nella scena

			controls = new THREE.OrbitControls(camera);
			controls.addEventListener('change', Render);


			// terrain
			var img = new Image();

			// load img source
			img.src = "textures/heightmap2.png";
			img.onload = function () {

				//get height data from img
				var data = getHeightData(img, 0.1);

			}


		}

		function Update() {
			requestAnimationFrame(Update);
			controls.update();
			stats.update();
			Render();
		}

		function Render() {



			renderer.render(scene, camera);
		}

		//INIZIALIZZA LE CARATTERISTICHE DEL RENDERER
		function InizializeRenderer() {
			renderer = new THREE.WebGLRenderer({
				antialias: true
			});
			renderer.setSize(window.innerWidth, window.innerHeight);
			renderer.setClearColor(0xf0f0f0);
			document.body.appendChild(renderer.domElement);

		}

		//INIZIALIZZA LE CARATTERISTICHE DELLA CAMERA
		function InizializeCamera() {
			camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
			camera.position.set(0, 6, -10);
			camera.lookAt(new THREE.Vector3(0, 0, 0));
		}

		//INIZIALIZZA LE CARATTERISTICHE DEI CUBI
		function InitializeCube() {
			geometry = new THREE.BoxGeometry(1, 1, 1);

			mapMaterial = new THREE.MeshLambertMaterial({
				color: 0xf5ad4b
			});
			playerMaterial = new THREE.MeshLambertMaterial({
				color: 0xff0000
			});

			cubeMap = new THREE.Mesh(geometry, mapMaterial);
			cubePlayer = new THREE.Mesh(geometry, playerMaterial);

			edges = new THREE.EdgesGeometry(geometry);
			line = new THREE.LineSegments(
				edges,
				new THREE.LineBasicMaterial({
					color: 0x000000
				})
			);


			DrawMapCubes();




		}

		function DrawPlayer() {

			cubePlayer.reciveShadow = true;
			cubePlayer.castShadow = true;
			cubePlayer.add(line);
		}

		function DrawMapCubes() {
			cubeMap.reciveShadow = true;
			cubeMap.castShadow = true;
			cubeMap.add(line);
		}




		//CREA GLI STATS DELLA SCENA
		function CreateStats() {
			stats = new Stats();
			stats.domElement.style.position = 'absolute';
			stats.domElement.style.top = '0px';
			document.body.appendChild(stats.domElement);
		}

		//CREA LA LUCE
		function CreateLight() {
			var pivot = new THREE.Object3D();
			scene.add(pivot);
			

			spotLight = new THREE.PointLight( 0xffffff, 1, 5 );

			

			cubePlayerPosition = new THREE.Vector3();
			cubePlayer.localToWorld(cubePlayerPosition);
			pivot.worldToLocal(cubePlayerPosition);
			cubePlayerPosition.sub(pivot.position);
			cubePlayerPosition.add(new THREE.Vector3(-0.7,2,-0.7));
			pivot.position.add(cubePlayerPosition);

			
			pivot.add(spotLight);
			
			console.log(pivot.position);

			//spotLight.position.set(0, 3, 1);
			

			scene.add(pivot);

		}

		//CREA LA MATRICE
		function CreateMatrix() {
			for (var i = 0; i < 6; i++) {
				matrix[i] = new Array(6);
			}

			for (var z = 0; z < 6; z++) {
				for (var x = 0; x < 6; x++) {
					matrix[z][x] = true;
				}
			}

			matrix[0][3] = false;
			matrix[1][1] = false;
			matrix[1][3] = false;
			matrix[1][5] = false;
			matrix[3][0] = false;
			matrix[3][1] = false;
			matrix[3][4] = false;
			matrix[4][1] = false;
			matrix[4][3] = false;
			matrix[5][3] = false;
			matrix[5][5] = false;
			
		}

		//CREA LA MAPPA IN BASE ALLA MATRICE 
		function CreateMap() {
			for (var z = 0; z < 6; z++) {
				for (var x = 0; x < 6; x++) {
					if (matrix[z][x] == true) {
						InitializeCube();

						scene.add(cubeMap);
						cubeMap.position.set(x, 0, z);
					}

				}
			}
		}

		function onDocumentKeyDown(event) {
			var keyCode = event.code;
			if (keyCode == 'KeyW') {
				moveCube("avanti")
			} else if (keyCode == 'KeyS') {
				moveCube("back")
			} else if (keyCode == 'KeyA') {
				moveCube("left")
			} else if (keyCode == 'KeyD') {
				moveCube("right")
			} else if (keyCode == 'Space') {
				cubePlayer.position.set(2, 1, 2);
			}
			Render();
			}

		function moveCube(direzione) {
			if (direzione == "avanti") {
				cubePlayer.translateZ(1);
				spotLight.translateZ(1);
			} else if (direzione == "back") {
				cubePlayer.translateZ(-1);
				spotLight.translateZ(-1);
			} else if (direzione == "left") {
				cubePlayer.translateX(1);
				spotLight.translateX(1);
			} else if (direzione == "right") {

				cubePlayer.translateX(-1);
				spotLight.translateX(-1);
			}

		}
/*
		function canMoveCube(cubePosition){
			for (let x = 0; x < 6; x++) {
				for (let z = 0; z < 6; z++) {
					if(matrix[x][z]==false)
					console.log("Movimento non valido");
					if(matrix[x][z]==true)
					console.log("Movimento valido");

				}	
			}
		}
*/










		Start();
		Update();
	</script>
</body>

</html>